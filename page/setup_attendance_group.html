<!-- 页面外套 -->
<div class="page-wrapper" id="setup_attendance_group">

    <!-- 数据网格 -->
    <div class="datagrid datagrid-striped" id="setup_attendance_group_datagrid">

        <!-- 工具条组 -->
        <div class="tool-group">
            <div class="tool-deal">
                <label><button class="btn btn-primary" id="setup_attendance_group_add_btn"> <i class="icon icon-plus"></i> 添加</button></label>
                <div class="clearfix"></div>
            </div>
        </div>
        <!-- tool-group -->

        <div class="datagrid-container"></div>
        <ul class="pager btn-mini" data-elements="prev,pages,next"></ul>
    </div>
    <!-- datagrid -->

    <!-- 添加盒子 -->
    <div class="modal modal-for-page fade" aria-hidden="false" id="setup_attendance_group_add_box">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">添加</h4>
                </div>
                <div class="modal-body modal-scroll">
                    <form class="container form-horizontal">
                        
                        <!-- 考勤组设置 -->
                        <table class="table table-bordered">
                            <thead><tr><th>考勤组设置</th></tr></thead>
                            <tbody><tr><td>
                                <div class="form-group require">
                                    <label class="col-sm-2" for="setup_attendance_group_add_name">考勤组名称</label>
                                    <div class="col-sm-8"><input type="text" class="form-control" id="setup_attendance_group_add_name" style="max-width:358px"></div>
                                </div>
                                <div class="form-group require">
                                    <label class="col-sm-2">考勤人员</label>
                                    <div class="col-sm-8"><ul class="tree tree-lines tree-chevrons" id="setup_attendance_group_add_tree"></ul></div>
                                </div>
                                <div class="form-group require">
                                    <label class="col-sm-2" for="setup_attendance_group_add_rule">加班规则</label>
                                    <div class="col-sm-8"><select class="form-control" id="setup_attendance_group_add_rule" style="max-width:358px"></select></div>
                                </div>
                                </td></tr></tbody>
                        </table>

                        <!-- 工作日设置 -->
                        <table class="table table-bordered">
                            <thead><tr><th>工作日设置</th></tr></thead>
                            <tbody><tr><td>
                                <div class="form-group require">
                                    <label class="col-sm-2">工作日设置</label>
                                    <div class="col-sm-8">
                                        <div class="btn-group btn_group_result" data-toggle="buttons" id="setup_attendance_group_add_week" result="1,2,3,4,5">
                                            <label class="btn active"><input type="checkbox" value="1">周一</label>
                                            <label class="btn active"><input type="checkbox" value="2">周二</label>
                                            <label class="btn active"><input type="checkbox" value="3">周三</label>
                                            <label class="btn active"><input type="checkbox" value="4">周四</label>
                                            <label class="btn active"><input type="checkbox" value="5">周五</label>
                                            <label class="btn">       <input type="checkbox" value="6">周六</label>
                                            <label class="btn">       <input type="checkbox" value="7">周日</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group require">
                                    <label class="col-sm-2">法节自动排休</label>
                                    <div class="col-sm-8">
                                        <div class="btn-group btn_group_result" data-toggle="buttons" id="setup_attendance_group_add_vaca" result="true">
                                            <label class="btn active"><input type="radio" value="true">启用</label>
                                            <label class="btn">       <input type="radio" value="false">禁用</label>
                                        </div>
                                    </div>
                                </div>                                
                                <div class="form-group require">
                                    <label class="col-sm-2" for="setup_attendance_group_add_time">班次时间设置</label>
                                    <div class="col-sm-8"><select class="form-control" id="setup_attendance_group_add_time" style="max-width:358px"></select></div>
                                </div>
                            </td></tr></tbody>
                        </table>

                        <!-- 考勤方式 -->
                        <table class="table table-bordered setup_attendance_group_add_table3">
                            <thead><tr><th colspan="2">考勤方式 <span class="text-danger text-thin">满足任意一种考勤方式即可完成打卡</span></th></tr></thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="col-sm-2">
                                            <label class="for-label for_label_toggle" id="setup_attendance_group_add_type1" style="margin-top:7px;">
                                                <i class="icon icon-check-empty"></i> 根据办公地点考勤
                                            </label>
                                        </div>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">有效范围</span>
                                                <input type="number" class="form-control" id="setup_attendance_group_add_type1_range">
                                                <span class="input-group-addon">米</span>
                                            </div>
                                        </div>
                                        <div class="col-sm-7">

                                            <!-- 地图选择 -->
                                            <div class="input-group map_select_result">
                                                <span class="input-group-addon">办公地点</span>
                                                <input type="text" class="form-control" placeholder="请选择办公地点" readonly id="setup_attendance_group_add_type1_addr" mapx="" mapy="">
                                                <span class="input-group-addon map_select_reset"><i class="icon icon-reply"></i></span>
                                                <strong>
                                                    <em id="map_select_map_box"></em>
                                                    <div class="flex-box">
                                                        <div class="flex-son"><input type="text" class="form-control input-sm map_select_map_input"></div>
                                                        <div style="width:120px;margin:0.5px 0 0 5px;text-align:center">
                                                            <button type="button" class="btn btn-primary btn-mini map_select_map_sea pull-left">搜索</button>
                                                            <button type="button" class="btn btn-primary btn-mini map_select_map_sub">提交</button>
                                                            <button type="button" class="btn btn-default btn-mini map_select_map_clo pull-right">关闭</button>
                                                        </div>
                                                    </div>
                                                </strong>
                                            </div>
                                        </div>
                                        <!-- 地图选择 -->

                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="col-sm-8">
                                            <label class="for-label for_label_toggle" id="setup_attendance_group_add_type2">
                                                <i class="icon icon-check-empty"></i> 根据公司WIFI
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="col-sm-8">
                                            <label class="for-label for_label_toggle" id="setup_attendance_group_add_type3">
                                                <i class="icon icon-check-empty"></i> 允许外勤打卡
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </form>
                    <div class="text-center" style="margin:100px 0">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="setup_attendance_group_add_submit">提交</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- setup_attendance_group_add_box -->

    <!-- 修改盒子 -->
    <div class="modal modal-for-page fade" aria-hidden="false" id="setup_attendance_group_edit_box">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">修改</h4>
                </div>
                <div class="modal-body modal-scroll">
                    <form class="container form-horizontal">

                    </form>
                    <div class="text-center">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="setup_attendance_group_edit_submit">提交</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- setup_attendance_group_edit_box -->

    <!-- 删除盒子 -->
    <div class="modal modal-for-page fade" aria-hidden="false" id="setup_attendance_group_dele_box">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">删除</h4>
                </div>
                <div class="modal-body">
                    <p class="text-danger"><i class="icon icon-warning-sign"></i> 是否删除？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-danger"  id="setup_attendance_group_dele_submit">提交</button>
                </div>
            </div>
        </div>
    </div>
    <!-- setup_attendance_group_dele_box -->

</div>
<!-- page-wrapper -->

<script>
$(function(){
   
    //变量声明-----------------------------------------------------------------------------------------------
    var 
    setup_attendance_group                  = $("#setup_attendance_group"),                 //页面ID
    setup_attendance_group_datagrid         = $("#setup_attendance_group_datagrid"),        //数据表格
    //添加
    setup_attendance_group_add_btn          = $("#setup_attendance_group_add_btn"),         //添加按钮
    setup_attendance_group_add_box          = $("#setup_attendance_group_add_box"),         //添加盒子
    setup_attendance_group_add_submit       = $("#setup_attendance_group_add_submit"),      //添加提交
    setup_attendance_group_add_name         = $("#setup_attendance_group_add_name"),        //考勤名称
    setup_attendance_group_add_tree         = $("#setup_attendance_group_add_tree"),        //考勤人员
    setup_attendance_group_add_rule         = $("#setup_attendance_group_add_rule"),        //加班规则
    setup_attendance_group_add_week         = $("#setup_attendance_group_add_week"),        //工作日设置
    setup_attendance_group_add_vaca         = $("#setup_attendance_group_add_vaca"),        //假期日设置
    setup_attendance_group_add_time         = $("#setup_attendance_group_add_time"),        //班次设置
    setup_attendance_group_add_table3       = $(".setup_attendance_group_add_table3"),      //考勤方式表格
    setup_attendance_group_add_type1        = $("#setup_attendance_group_add_type1"),       //考勤方式1
    setup_attendance_group_add_type1_range  = $("#setup_attendance_group_add_type1_range"), //范围
    setup_attendance_group_add_type1_addr   = $("#setup_attendance_group_add_type1_addr"),  //地点
    setup_attendance_group_add_type2        = $("#setup_attendance_group_add_type2"),       //考勤方式2
    setup_attendance_group_add_type3        = $("#setup_attendance_group_add_type3"),       //考勤方式3
    //修改
    setup_attendance_group_edit_box         = $("#setup_attendance_group_edit_box"),        //修改盒子
    setup_attendance_group_edit_submit      = $("#setup_attendance_group_edit_submit"),     //修改提交
    //删除
    setup_attendance_group_dele_box         = $("#setup_attendance_group_dele_box"),        //删除盒子
    setup_attendance_group_dele_submit      = $("#setup_attendance_group_dele_submit");     //删除提交

    //接口对象-----------------------------------------------------------------------------------------------
    if( window.STATE == "local" ){

        //本地接口
        var setup_attendance_group_api = {
            datagrid   : LOCAL + "Test/test_datagrid.json",                                 //数据表格
            select     : LOCAL + "Test/test_select.json",                                   //下拉选项
            modal_edit : LOCAL + "Test/Setup/Attendance/group_edit.json",                   //修改盒子
        }

    } else if ( window.STATE == "route" ){

        //远程接口
        var setup_attendance_group_api = {
            datagrid   : LOCAL + "Test/test_datagrid.json",                                 //数据表格
            select     : LOCAL + "Test/test_select.json",                                   //下拉选项
            modal_edit : LOCAL + "Test/Setup/Attendance/group_edit.json",                   //修改盒子
        }

    }

    //数据表格-----------------------------------------------------------------------------------------------
    setup_attendance_group_datagrid.datagrid({
        height      : zui_datagrid_height(setup_attendance_group_datagrid),
        sortable    : false,
        cache       : false,
        showRowIndex: true,
        configs     : {
            R0:{className:"text-center"},
            C1:{className:"cell-hidden"}
        },
        states      : {
            pager           : {
                page        : 1,
                recPerPage  : window.REC_PER_PAGE,
            }
        },
        dataSource : {
            cols   : [
                {name:"id",      label:"ID",  width:49 },
                {name:"tex10",   label:"名称",width:250},
                {name:"text1",   label:"人数",width:80 },
                {name:"operate", label:"操作",width:150,
                    html:true,
                    valueOperator : {
                        getter : function(dataValue,cell){
                            var temp = `
                                <a class="setup_attendance_group_edit_btn" rowIndex="${cell.rowIndex}">修改</a>
                                <a class="setup_attendance_group_dele_btn" rowIndex="${cell.rowIndex}">删除</a>
                            `;
                            return temp;
                        }
                    }
                }
            ],
            remote : function(){
                return {
                    url     : setup_attendance_group_api.datagrid,
                    type    : "POST",
                    dataType: "json",
                }
            }
        }
    });

    //变量声明-----------------------------------------------------------------------------------------------
    var
    setup_attendance_group_datagrid_obj   = setup_attendance_group_datagrid.data("zui.datagrid"),   //表格对象
    setup_attendance_group_edit_btn       = ".setup_attendance_group_edit_btn",                     //修改按钮
    setup_attendance_group_dele_btn       = ".setup_attendance_group_dele_btn";                     //删除按钮

    //节点树创建(添加+修改)--------------------------------------------------------------------------------
    common_tree_staff(setup_attendance_group_add_tree,3,false,true);        //添加
    //common_tree_staff(setup_attendance_group_edit_tree,3,false,true);       //修改

    //下拉选项-----------------------------------------------------------------------------------------------
    //加班规则
    $.ajax({
        url     : setup_attendance_group_api.select,
        type    : "post",
        dataType: "json",
        data    : {},
        success : function(data){
            if( data.status>0 ){
                var data = data.data;
                var option = "<option>全部</option>";
                for(var i=0;i<data.length;i++){
                    option += "<option value='"+data[i].id+"'>"+data[i].name+"</option>"
                }
                setup_attendance_group_add_rule.html(option);               //添加
                //setup_attendance_group_edit_rule.html(option);              //修改 
            }
        }
    });
    //班次设置
    $.ajax({
        url     : setup_attendance_group_api.select,
        type    : "post",
        dataType: "json",
        data    : {},
        success : function(data){
            if( data.status>0 ){
                var data = data.data;
                var option = "<option>全部</option>";
                for(var i=0;i<data.length;i++){
                    option += "<option value='"+data[i].id+"'>"+data[i].name+"</option>"
                }
                setup_attendance_group_add_time.html(option);               //添加
                //setup_attendance_group_edit_time.html(option);              //修改 
            }
        }
    });

    //添加按钮-----------------------------------------------------------------------------------------------
    setup_attendance_group_add_btn.click(function(){

        //数据重置
        common_tree_staff_reset( setup_attendance_group_add_tree );
        setup_attendance_group_add_week.attr("result","1,2,3,4,5").find(".btn").removeClass("active");
        for( var i=0;i<5;i++ ){ setup_attendance_group_add_week.find(".btn").eq(i).addClass("active"); }
        setup_attendance_group_add_vaca.find(".btn").eq(0).trigger("click");
        common_for_label_toggle_reset( setup_attendance_group_add_table3 );
        setup_attendance_group_add_table3.find(".map_select_reset").trigger("click");

        //面板显示
        setup_attendance_group_add_box.modal("show");
        
    });
    //添加提交
    setup_attendance_group_add_submit.click(function(){
 
        //远程提交
        $.ajax({
            url     : API.test_response,
            type    : "post",
            dataType: "json",
            data    : {
                name : setup_attendance_group_add_name.val(),
                tree : setup_attendance_group_add_tree.attr("result"),
                rule : setup_attendance_group_add_rule.val(),
                week : setup_attendance_group_add_week.attr("result"),
                vaca : setup_attendance_group_add_vaca.attr("result"),
                time : setup_attendance_group_add_time.val(),
                type1: setup_attendance_group_add_type1.find(".icon").hasClass("icon-checked"),
                type2: setup_attendance_group_add_type1.find(".icon").hasClass("icon-checked"),
                type3: setup_attendance_group_add_type1.find(".icon").hasClass("icon-checked"),
                range: setup_attendance_group_add_type1_range.val(),
                addr : setup_attendance_group_add_type1_addr.val(),
                mapx : setup_attendance_group_add_type1_addr.attr("mapx"),
                mapy : setup_attendance_group_add_type1_addr.attr("mapy"),
            },
            success : function(data){
                if( data.status>0 ){
                    um_tip(data.message);
                    zui_datagrid_reset(setup_attendance_group_datagrid_obj,setup_attendance_group_api.datagrid);
                } else {
                    um_tip(data.message,"1500","text-danger");
                }
            }
        });

    });

    //修改按钮-----------------------------------------------------------------------------------------------
    $(document).on("click",setup_attendance_group_edit_btn,function(){
  
        //数据ID
        var data_id = zui_datagrid_get_id($(this).attr("rowIndex"));

        //远程提交
        $.ajax({
            url     : setup_attendance_group_api.modal_edit,
            type    : "post",
            dataType: "json",
            data    : { id:data_id },
            success : function(data){
                if( data.status>0 ){
                    var data = data.data;
                    
                    //数据赋值
                    console.log( data );

                    //其他操作
                    setup_attendance_group_edit_submit.attr("dataId",data_id);  //数据ID传值
                    setup_attendance_group_edit_box.modal("show");              //盒子显示

                } else {
                    um_tip(data.message,"1500","text-danger");
                }
            }
        });

    });
    //修改提交
    setup_attendance_group_edit_submit.click(function(){

        //数据ID
        var data_id = $(this).attr("dataId");

        //远程提交
        $.ajax({
            url     : API.test_response,
            type    : "post",
            dataType: "json",
            data    : { 
                id   : data_id,
                rule : 1,
             },
            success : function(data){
                if( data.status>0 ){
                    um_tip(data.message);
                    zui_datagrid_reset(setup_attendance_group_datagrid_obj,setup_attendance_group_api.datagrid);
                } else {
                    um_tip(data.message,"1500","text-danger");
                }
            }
        });

    });

    //删除按钮-----------------------------------------------------------------------------------------------
    $(document).on("click",setup_attendance_group_dele_btn,function(){

        //数据ID
        var data_id = zui_datagrid_get_id($(this).attr("rowIndex"));

        //其他操作
        setup_attendance_group_dele_submit.attr("dataId",data_id);                                //ID传值
        setup_attendance_group_dele_box.modal("show");                                            //面板显示

    });
    //删除提交
    setup_attendance_group_dele_submit.click(function(){

        //数据ID
        var data_id = $(this).attr("dataId");

        //远程提交
        $.ajax({
            url     : API.test_response,
            type    : "post",
            dataType: "json",
            data    : { id:data_id },
            success : function(data){
                if( data.status>0 ){
                    um_tip(data.message);
                    zui_datagrid_reset(setup_attendance_group_datagrid_obj,setup_attendance_group_api.datagrid);
                } else {
                    um_tip(data.message,"1500","text-danger");
                }
            }
        });

    });

    //地图组件-----------------------------------------------------------------------------------------------
    map_select_result  = $(".map_select_result"),                           //地图组件
    map_select_input   = setup_attendance_group_add_type1_addr,             //文本框
    map_select_reset   = map_select_result.find(".map_select_reset"),       //重置按钮
    map_select_modal   = map_select_result.find("strong"),                  //地图面板
    map_select_map_inp = map_select_result.find(".map_select_map_input"),   //地址搜索
    map_select_map_sea = map_select_result.find(".map_select_map_sea"),     //搜索按钮
    map_select_map_sub = map_select_result.find(".map_select_map_sub"),     //提交按钮
    map_select_map_clo = map_select_result.find(".map_select_map_clo");     //关闭按钮
    //地图-初始化
    var map = new BMap.Map("map_select_map_box",{minZoom:5,maxZoom:19});    //缩放级别
    map.centerAndZoom(new BMap.Point(121.36564,31.22611),19);               //默认坐标
    map.enableScrollWheelZoom(true);                                        //滚动缩放
    map.addControl(new BMap.NavigationControl());                           //平移缩放
    //文本框点击
    map_select_input.click(function(){   map_select_modal.show(); });
    //关闭按钮
    map_select_map_clo.click(function(){ map_select_modal.hide(); });
    //搜索按钮
    map_select_map_sea.click(function(){
        var local = new BMap.LocalSearch(map,{renderOptions:{map:map}});
        var city = map_select_map_inp.val();
        if( city!="" ){ local.search(city); }
    });
    //地图点击
    map.addEventListener("click",function(e){
        map_select_input.attr("mapx",e.point.lat);
        map_select_input.attr("mapy",e.point.lng);
    });
    //提交按钮
    map_select_map_sub.click(function(e){
        var name = $(".BMap_pop p").text();
        var addr = $(".BMap_pop table tr:nth-child(1) td:nth-child(2)").text();
        var mapx = map_select_input.attr("mapx");
        var mapy = map_select_input.attr("mapy");
        if( mapx!="" && mapy!="" ){
            map_select_input.val( name+"("+addr+")" );
            map_select_modal.hide(); 
        } else {
            um_tip("请点击选择地址","1500","text-danger");
        }
    });
    //重置按钮
    map_select_reset.click(function(){
        //数据重置
        map_select_input.val("");
        map_select_input.attr("mapx","");
        map_select_input.attr("mapy","");
        map_select_map_inp.val("");
        //面板隐藏
        map_select_modal.hide();
    });

});//预加载结尾
</script>