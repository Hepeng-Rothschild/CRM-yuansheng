<!-- 页面外套 -->
<div class="page-wrapper" id="office_apply_attendTravel">

    <!-- 数据网格 -->
    <div class="datagrid datagrid-striped">
        <!-- 工具条组 -->
        <div class="tool-group">
            <form class="tool-search">
                <input type="hidden" name='page'>
                <input type="hidden" name='recPerPage'>
                <div class="im-label">
                    <div class="input-group">
                        <select class="form-control" name="sid"><option value="1">流水号</option></select>
                        <span class="input-group-addon fix-border fix-padding"></span>
                        <input type="text" class="form-control" name="search">
                    </div>
                </div>
                <div class="im-label">
                    <span>申请时间</span>
                    <div class="input-group">
                        <input type="text" class="form-control" name="starttime" readonly> 
                        <span class="input-group-addon fix-border fix-padding"></span>
                        <input type="text" class="form-control" name="endtime"readonly>
                    </div>
                </div>
                <label>
                    <span>审批状态</span>
                    <select class="form-control" name="state">
                        <option value="0">全部</option>
                        <option value="1">审批中</option>
                        <option value="2">审批完成</option>
                        <option value="3">撤销</option>
                        <option value="4">已撤销</option>
                    </select>
                </label>
                <label><button type="button" class="btn btn-primary tool_search_btn"><i class="icon icon-search"></i> 搜索</button></label>
                <div class="clearfix"></div>
            </form>
            <div class="tool-deal">
                <label><button type="button" class="btn btn-primary tool_add_btn"><i class="icon icon-plus"></i>添加</button></label>
                <div class="clearfix"></div>
            </div>
        </div>
        <!-- tool-group -->

        <div class="datagrid-container"></div>
        <ul class="pager btn-mini" data-elements="prev,pages,next"></ul>
    </div>
    <!-- datagrid -->

    <!-- 添加盒子 -->
    <div class="modal modal-for-page fade tool_add_box" aria-hidden="false">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">添加</h4>
                </div>
                <div class="modal-body modal-scroll">
                    <form class="container form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-1">出差原因</label>
                            <div class="col-sm-11"><textarea class="form-control" name="text"></textarea></div>
                        </div>
                        <!-- 添加行程 -->
                        <table class="table table-condensed box_travelAdd_table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>交通工具</th>
                                    <th>单程往返</th>
                                    <th>出发城市</th>
                                    <th>目的城市</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="bold text-primary">行程1</td>
                                    <td>
                                        <select class="form-control" name="tool1">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type1">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from1"></td>
                                    <td><input type="text" class="form-control" name="to1"></td>
                                </tr>
                                <tr>
                                    <td class="bold text-primary">行程2</td>
                                    <td>
                                        <select class="form-control" name="tool2">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type2">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from2"></td>
                                    <td><input type="text" class="form-control" name="to2"></td>
                                </tr>
                                <tr>
                                    <td class="bold text-primary">行程3</td>
                                    <td>
                                        <select class="form-control" name="tool3">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type3">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from3"></td>
                                    <td><input type="text" class="form-control" name="to3"></td>
                                </tr>
                                <tr>
                                    <td class="bold text-primary">行程4</td>
                                    <td>
                                        <select class="form-control" name="tool4">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type4">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from4"></td>
                                    <td><input type="text" class="form-control" name="to4"></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-right"><button type="button" class="btn btn-success box_travelAdd_btn">添加行程</button></td>
                                </tr>
                            </tfoot>
                        </table>
                        <hr>
                        <div class="form-group">
                            <label class="col-sm-1">抄送人</label>
                            <div class="col-sm-5">
                                <div class="office-border">
                                    <ul class="tree tree-lines tree-chevrons box_copyer"></ul>
                                    <input type="hidden" class="tree_result_id" name="copyer">
                                </div>
                            </div>
                            <label class="col-sm-1">审批人</label>
                            <div class="col-sm-5">
                                <div class="office-border"><div class="office-approval box_approver"><!-- JS推进 --></div></div>
                            </div>
                        </div>
                        <hr>
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary tool_add_submit">提交</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改盒子 -->
    <div class="modal modal-for-page fade line_edit_box" aria-hidden="false">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">再次申请</h4>
                </div>
                <div class="modal-body modal-scroll">
                    <form class="container form-horizontal">
                        <input type="hidden" name="id">
                        <div class="form-group">
                            <label class="col-sm-1">出差原因</label>
                            <div class="col-sm-11"><textarea class="form-control" name="text"></textarea></div>
                        </div>
                        <!-- 添加行程 -->
                        <table class="table table-condensed box_travelAdd_table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>交通工具</th>
                                    <th>单程往返</th>
                                    <th>出发城市</th>
                                    <th>目的城市</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="bold text-primary">行程1</td>
                                    <td>
                                        <select class="form-control" name="tool1">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type1">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from1"></td>
                                    <td><input type="text" class="form-control" name="to1"></td>
                                </tr>
                                <tr>
                                    <td class="bold text-primary">行程2</td>
                                    <td>
                                        <select class="form-control" name="tool2">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type2">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from2"></td>
                                    <td><input type="text" class="form-control" name="to2"></td>
                                </tr>
                                <tr>
                                    <td class="bold text-primary">行程3</td>
                                    <td>
                                        <select class="form-control" name="tool3">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type3">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from3"></td>
                                    <td><input type="text" class="form-control" name="to3"></td>
                                </tr>
                                <tr>
                                    <td class="bold text-primary">行程4</td>
                                    <td>
                                        <select class="form-control" name="tool4">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">飞机</option>
                                            <option value="2">火车</option>
                                            <option value="3">汽车</option>
                                            <option value="4">其他</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="type4">
                                            <option value="">-- 请选择 --</option>
                                            <option value="1">单程</option>
                                            <option value="2">往返</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="from4"></td>
                                    <td><input type="text" class="form-control" name="to4"></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-right"><button type="button" class="btn btn-success box_travelAdd_btn">添加行程</button></td>
                                </tr>
                            </tfoot>
                        </table>
                        <hr>
                        <div class="form-group">
                            <label class="col-sm-1">抄送人</label>
                            <div class="col-sm-5">
                                <div class="office-border">
                                    <ul class="tree tree-lines tree-chevrons box_copyer"></ul>
                                    <input type="hidden" class="tree_result_id" name="copyer">
                                </div>
                            </div>
                            <label class="col-sm-1">审批人</label>
                            <div class="col-sm-5">
                                <div class="office-border"><div class="office-approval box_approver"><!-- JS推进 --></div></div>
                            </div>
                        </div>
                        <hr>
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary line_edit_submit">提交</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看盒子 -->
    <div class="modal modal-for-page fade line_show_box" aria-hidden="false">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">查看</h4>
                </div>
                <div class="modal-body modal-scroll">
                    <div class="container">
                        <table class="table detail-table">
                            <tbody><!-- JS推进 --></tbody>
                            <tfoot><tr><td colspan="5">
                                <div class="col-sm-6">
                                    <b>抄送人</b>
                                    <div class="office-border"><ul class="tree tree-lines tree-chevrons box_copyer"></ul></div>
                                </div>
                                <div class="col-sm-6">
                                    <b>审批人</b>
                                    <div class="office-border"><div class="office-approval box_approver"><!-- JS推进 --></div></div>
                                </div>
                            </td></tr></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 撤销盒子 -->
    <div class="modal modal-for-page fade line_back_box" aria-hidden="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">撤销</h4>
                </div>
                <div class="modal-body">
                    <p>是否撤销？</p>
                    <form><input type="hidden" name="id"></form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary line_back_submit">提交</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 催办盒子 -->
    <div class="modal modal-for-page fade line_urge_box" aria-hidden="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">催办</h4>
                </div>
                <div class="modal-body">
                    <p>是否催办？</p>
                    <form><input type="hidden" name="id"></form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary line_urge_submit">提交</button>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- page-wrapper -->

<script>
$(function() {

    // 变量声明-----------------------------------------------------------------------------------------------
    var office_apply_attendTravel = $("#office_apply_attendTravel"); // 页面ID
    var office_apply_attendTravel_api = {
        datagrid : API.test_datagrid, // 数据表格
        compensate : LOCAL + "Test/test_select.json", //出差补偿
        tree : API.common_staff, // 员工树状图
        approval : LOCAL + "Test/Office/apply/attend_approval.json", // 审批人进度
        show : LOCAL + "Test/Office/apply/attend_travel.json", // 查看
        add  : API.test_response, // 添加
        edit : API.test_response, // 修改
        back : API.test_response, // 撤销
        urge : API.test_response, // 催办
    }

    // 数据表格-----------------------------------------------------------------------------------------------
    // 数据源
    var office_apply_attendTravel_dataSource = {
        cols   : [
            {name: "datetime", label: "申请时间", width: 150},
            {name: "username", label: "流水号", width: 90, html: true,
                valueOperator: {
                    getter: function(dataValue, cell) {
                        return `<a class="line_show_btn" dataId="${cell.config.data.id}">${dataValue}</a>`;
                    }
                }
            },
            {name: "datetime", label: "开始时间", width: 140},
            {name: "datetime", label: "结束时间", width: 140},
            {name: "text4", label: "出差天数", width: 90},
            {name: "text4", label:"审批状态", width:90},
            {name:"", label:"操作", width:90, html:true,
                valueOperator : {
                    getter : function(dataValue,cell){
                        var temp='';
                        var state = cell.config.data.state;
                        if( state==1 ){ 
                            temp = `
                            <a class="line_back_btn" dataId="${cell.config.data.id}">撤销</a>
                            <a class="line_urge_btn" dataId="${cell.config.data.id}">催办</a>`;
                        } else if ( state==3 ){ 
                            temp =`<a class="line_edit_btn" dataId="${cell.config.data.id}">再次申请</a>`;
                        }
                        return temp;
                    }
                }
            }
        ],
        remote : function(){
            return zui_datagrid_remote({
                page_dom : office_apply_attendTravel, 
                url      : office_apply_attendTravel_api.datagrid
            });
        },
        remoteConverter : function(data){ 
            return zui_datagrid_filter({
                page_dom : office_apply_attendTravel,
                data     : data
            });
        }
    };
    // 实例化
    office_apply_attendTravel.find('.datagrid').datagrid(
        zui_datagrid_option({
            datagrid   : office_apply_attendTravel.find('.datagrid'),
            dataSource : office_apply_attendTravel_dataSource
        })
    );
    // 搜索
    office_apply_attendTravel.find('.tool_search_btn').click(function(){ 
        zui_datagrid_render({
            datagrid_obj : office_apply_attendTravel.find('.datagrid').data("zui.datagrid"),
            dataSource   : office_apply_attendTravel_dataSource
        }); 
    });

    // 操作按钮-----------------------------------------------------------------------------------------------
    // 添加
    office_apply_attendTravel.find('.tool_add_btn').click(function() {
        common_form_reset();
        office_apply_attendTravel.find('.tool_add_box .box_travelAdd_table tbody tr').hide(); // 行程重置
        common_approval_create({
            dom : office_apply_attendTravel.find('.tool_add_box .box_approver'),
            url : office_apply_attendTravel_api.approval,
            data : { 'id' : '自定义传参' }
        }); 
        office_apply_attendTravel.find('.tool_add_box').modal('show');
    });
    office_apply_attendTravel.find('.tool_add_submit').click(function() {
        um_data_submit({
            url: office_apply_attendTravel_api.add,
            form: office_apply_attendTravel.find('.tool_add_box form'),
            dataSource: office_apply_attendTravel_dataSource,
        });
    });

    // 修改
    office_apply_attendTravel.on("click", '.line_edit_btn', function() {
        office_apply_attendTravel.find('.line_edit_box [name="id"]').val( $(this).attr('dataId') );
        $.ajax({
            url     : office_apply_attendTravel_api.show,
            data    : { id: $(this).attr('dataId') },
            type    : "post",
            dataType: "json",
            success : function(data){
                var data = data.data;
                um_data_set(office_apply_attendTravel.find('.line_edit_box form'), data);
                office_apply_attendTravel.find('.line_edit_box').modal('show');
                // 行程
                office_apply_attendTravel.find('.line_edit_box .box_travelAdd_table tbody tr').hide(); // 行程重置
                for(var i=0;i<data.travelGroup.length;i++){
                    var trShow = office_apply_attendTravel.find('.line_edit_box .box_travelAdd_table tbody tr').eq(i);
                    trShow.find('td').eq(1).find('[name]').val(data.travelGroup[i].tool);
                    trShow.find('td').eq(2).find('[name]').val(data.travelGroup[i].type);
                    trShow.find('td').eq(3).find('[name]').val(data.travelGroup[i].from);
                    trShow.find('td').eq(4).find('[name]').val(data.travelGroup[i].to  );
                    trShow.show();
                }
                // 抄送人
                common_tree_setData({
                    dom : office_apply_attendTravel.find('.line_edit_box .box_copyer'),
                    data : data.treeAll
                });
                // 审批人
                common_approval_setData({
                    dom: office_apply_attendTravel.find('.line_edit_box .box_approver'),
                    data : data.approval
                });
            }
        });
    });
    office_apply_attendTravel.find('.line_edit_submit').click(function() {
        um_data_submit({
            url: office_apply_attendTravel_api.edit,
            form: office_apply_attendTravel.find('.line_edit_box form'),
            dataSource: office_apply_attendTravel_dataSource,
        });
    });

    // 查看
    office_apply_attendTravel.on("click", '.line_show_btn', function() {
        $.ajax({
            url     : office_apply_attendTravel_api.show,
            data    : { id: $(this).attr('dataId') },
            type    : "post",
            dataType: "json",
            success : function(data){
                var data = data.data;
                var temp = `
                <tr><td colspan="5"><b>流水号</b>   ${data.serialnumber}</td></tr>
                <tr><td colspan="5"><b>审批状态</b> ${data.statename}</td></tr>
                <tr><td colspan="5"><b>出差原因</b> ${data.text}</td></tr>
                <tr style="background:#f5f5f5;">
                    <td style="color:#000;">#</td>
                    <td style="color:#000;">交通工具</td>
                    <td style="color:#000;">单程往返</td>
                    <td style="color:#000;">出发城市</td>
                    <td style="color:#000;">目的城市</td>
                </tr>`;
                for(var i=0;i<data.travelGroup.length;i++){
                    temp += `
                    <tr>
                        <td style="color:#3280fc">行程${i+1}</td>
                        <td>${data.travelGroup[i].toolname}</td>
                        <td>${data.travelGroup[i].typename}</td>
                        <td>${data.travelGroup[i].from}</td>
                        <td>${data.travelGroup[i].to}</td>
                    </tr>`;
                }
                office_apply_attendTravel.find('.line_show_box tbody').html(temp);
                office_apply_attendTravel.find('.line_show_box').modal('show');
                // 抄送人
                common_tree_setData({
                    dom : office_apply_attendTravel.find('.line_show_box .box_copyer'),
                    data : data.treeChecked
                });
                // 审批人
                common_approval_setData({
                    dom: office_apply_attendTravel.find('.line_show_box .box_approver'),
                    data : data.approval
                }); 
            }
        });
    });

    // 撤销
    office_apply_attendTravel.on("click", '.line_back_btn', function() {
        office_apply_attendTravel.find('.line_back_box [name="id"]').val( $(this).attr('dataId') );
        office_apply_attendTravel.find('.line_back_box').modal('show');
    });
    office_apply_attendTravel.on("click", '.line_back_submit', function() {
        um_data_submit({
            url: office_apply_attendTravel_api.back,
            form: office_apply_attendTravel.find('.line_back_box form'),
            dataSource: office_apply_attendTravel_dataSource,
        });
    });

    // 催办
    office_apply_attendTravel.on("click", '.line_urge_btn', function() {
        office_apply_attendTravel.find('.line_urge_box [name="id"]').val( $(this).attr('dataId') );
        office_apply_attendTravel.find('.line_urge_box').modal('show');
    });
    office_apply_attendTravel.on("click", '.line_urge_submit', function() {
        um_data_submit({
            url: office_apply_attendTravel_api.urge,
            form: office_apply_attendTravel.find('.line_urge_box form'),
            dataSource: office_apply_attendTravel_dataSource,
        });
    });

    // 日期相关---------------------------------------------------------------------------------------------
    office_apply_attendTravel.find('.tool-search [name="starttime"]').datetimepicker(option_date);
    office_apply_attendTravel.find('.tool-search [name="endtime"]').datetimepicker(option_date);

    // 抄送人/审批人相关-----------------------------------------------------------------------------------
    common_tree_create({
        dom : office_apply_attendTravel.find('.tool_add_box .box_copyer'),
        url : office_apply_attendTravel_api.tree,
        is_open : true,
        is_check : true,
    });
    common_tree_create({
        dom : office_apply_attendTravel.find('.line_edit_box .box_copyer'),
        url : office_apply_attendTravel_api.tree,
        is_open : true,
        is_check : true,
    });
    common_tree_create({
        dom : office_apply_attendTravel.find('.line_show_box .box_copyer'),
        url : office_apply_attendTravel_api.tree,
        is_open : true,
    });

    // 添加行程--------------------------------------------------------------------------------------------
    office_apply_attendTravel.on('click', '.box_travelAdd_btn', function(){
        var trAll = $(this).parents('.box_travelAdd_table').find('tbody tr');
        var trShow = $(this).parents('.box_travelAdd_table').find('tbody tr:visible');
        trAll.eq( trShow.length ).show();
        if( trShow.length !=0 && trShow.length == trAll.length -1 ){ $(this).hide(); }
    });

}); // 预加载结尾
</script>

<style>
    #office_apply_attendTravel .box_travelAdd_table *{
        font-size: small!important;
        font-weight: normal;
    }
    #office_apply_attendTravel .box_travelAdd_table tbody tr{
        display: none;
    }
</style>