<!-- 页面外套 -->
<div class="page-wrapper" id="personnel_company">

    <!-- 工具条组 -->
    <div class="tool-group">
        <div class="tool-inline">
            <label><select class="form-control" id="personnel_company_tool_select1" style="width:360px!important;"><!-- JS推进 --></select></label>
            <div class="clearfix"></div>
            <label><button class="btn btn-primary" company-id="" id="personnel_company_structure_btn"><i class="icon icon-sitemap"></i> 组织架构表</button></label>
        </div>
    </div>
    <!-- tool-group -->

    <!-- 高亮区域 -->
    <div class="hl-default" style="padding:30px 35px;">
        <div class="tree-folders tree-lines" id="personnel_company_tree"></div>
    </div>
    <!-- hl-default -->

    <!-- 组织架构表 -->
    <div class="modal modal-for-page fade" aria-hidden="false" id="personnel_company_structure_box">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">组织架构表</h4>
                </div>
                <div class="modal-body">
                    <div id="personnel_company_structure_dom"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" data-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!-- personnel_company_structure_box -->

</div>
<!-- page-wrapper -->
<script>
$(function(){
    
    //变量声明------------------------------------------------------------------------
    var
    personnel_company               = $("#personnel_company"),                  //页面ID
    personnel_company_tool_select1  = $("#personnel_company_tool_select1"),     //下拉选择
    personnel_company_structure_btn = $("#personnel_company_structure_btn"),    //架构按钮
    personnel_company_structure_box = $("#personnel_company_structure_box"),    //架构面板
    personnel_company_structure_dom = $("#personnel_company_structure_dom"),    //架构组件
    personnel_company_tree          = $("#personnel_company_tree");             //数据节点树


    //接口对象-----------------------------------------------------------------------------------------------
    if( window.STATE == "local" ){

        //本地接口
        var personnel_company_api = {
            select    : LOCAL + "Company/getAllCompany.json",                   //下拉选择
            tree      : LOCAL + "Company/getCompanybyid.json",                  //数据表格
            structure : LOCAL + "Company/getdeparmentid.json",                  //组织架构表
            second    : LOCAL + "Company/getSCompanybyid.json",                 //获取二级部门
        }

    } else if ( window.STATE == "route" ){

        //远程接口
        var personnel_company_api = {
            select    : ROUTE + "Company/getAllCompany",                        //下拉选择
            tree      : ROUTE + "Company/getCompanybyid",                       //数据表格
            structure : ROUTE + "Company/getdeparmentid",                       //组织架构表
            second    : ROUTE + "Company/getSCompanybyid",                      //获取二级部门
        }

    }

    //下拉选择------------------------------------------------------------------------
    $.ajax({
        url     : personnel_company_api.select,
        type    : "POST",
        dataType: "json",
        success : function(data){
            //变量声明
            // var data = data.data;
            var personnel_company_first_id = data[0].id;                    //初始ID

            //下拉选择-选项填充
            var resu = "";
            for(i=0;i<data.length;i++){
                resu += `<option value="${data[i].id}">${data[i].name}</option>`;
            }
            personnel_company_tool_select1.html(resu);

            //架构组件-ID影响
            personnel_company_structure_btn.attr("company-id",personnel_company_first_id);

            //节点树
            personnel_company_tree_create( personnel_company_first_id );
           
        }
    }); 

    //下拉选择-改动-------------------------------------------------------------------
    personnel_company_tool_select1.change(function(){

        //变量声明
        var data_id = personnel_company_tool_select1.val();                                         //数据ID

        //组织架构表刷新
        personnel_company_structure_btn.attr("company-id",data_id);

        //节点树刷新
        personnel_company_tree_create( data_id );
      
    });

    //架构组件------------------------------------------------------------------------
    personnel_company_structure_btn.click(function(){
        $.ajax({
            url     : personnel_company_api.structure,
            type    : "POST",
            dataType: "json",
            data    : { id  : personnel_company_structure_btn.attr("company-id") },
            success : function(data){
                // var data = data.data;
                var data = um_json(data);                                                           //JSON解析
                personnel_company_structure_dom.treemap("render",data);                             //架构渲染
                personnel_company_structure_box.modal("show");                                      //面板显示
            }
        });
    });

    //节点树-生成
    function personnel_company_tree_create(id){
        $.ajax({
            url     : personnel_company_api.tree,
            type    : "post",
            data    : { id  : id },
            success : function(data){
                var data = um_json(data);
                personnel_company_tree.tree({
                    data        : data,
                    itemCreator : function($li,item){
                        $li.addClass("open");
                        $li.append( $("<span>").html(item.title) );
                    },
                });
            }
        });
    }

    //节点树-点击选中
    personnel_company_tree.on("click","span",function(){
        personnel_company_tree.find("span").removeClass("text-primary");
        $(this).addClass("text-primary");
    });

});//预加载结尾
</script>