<!-- 页面外套 -->
<div class="page-wrapper" id="personnel_company">

    <!-- 数据网格 -->
	<div class="datagrid datagrid-striped" id="personnel_company_datagrid">
        <div class="tool-group">
            <div class="tool-inline">
                <label><select class="form-control" id="personnel_company_tool_select1"><!-- JS推进 --></select></label>
                <div class="clearfix"></div>
                <label><button class="btn btn-primary" company-id="" id="personnel_company_structure_btn"><i class="icon icon-sitemap"></i> 组织架构表</button></label>
            </div>
        </div>
        <div class="datagrid-container"></div>
        <ul class="pager btn-mini" data-elements="prev,pages,next"></ul>
    </div>
    <!-- datagrid -->

    <!-- 组织架构表 -->
    <div class="modal modal-for-page fade" aria-hidden="false" id="personnel_company_structure_box">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">组织架构表</h4>
                </div>
                <div class="modal-body">
                    <div id="personnel_company_structure_dom"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" data-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!-- personnel_company_structure_box -->

</div>
<!-- page-wrapper -->
<script>
$(function(){
    
    //变量声明------------------------------------------------------------------------
    var
    personnel_company               = $("#personnel_company"),                  //页面ID
    personnel_company_tool_select1  = $("#personnel_company_tool_select1"),     //下拉选择
    personnel_company_structure_btn = $("#personnel_company_structure_btn"),    //架构按钮
    personnel_company_structure_box = $("#personnel_company_structure_box"),    //架构面板
    personnel_company_structure_dom = $("#personnel_company_structure_dom"),    //架构组件
    personnel_company_datagrid      = $("#personnel_company_datagrid"),         //数据表格
    personnel_company_datagrid_obj  = "";                                       //表格对象

    //接口对象-----------------------------------------------------------------------------------------------
    if( window.STATE == "local" ){

        //本地接口
        var personnel_company_api = {
            select    : LOCAL + "Company/getAllCompany.json",                   //下拉选择
            datagrid  : LOCAL + "Company/getCompanybyid.json",                  //数据表格
            structure : LOCAL + "Company/getdeparmentid.json",                  //组织架构表
            second    : LOCAL + "Company/getSCompanybyid.json",                 //获取二级部门
        }

    } else if ( window.STATE == "route" ){

        //远程接口
        var personnel_company_api = {
            select    : ROUTE + "Company/getAllCompany",                        //下拉选择
            datagrid  : ROUTE + "Company/getCompanybyid",                       //数据表格
            structure : ROUTE + "Company/getdeparmentid",                       //组织架构表
            second    : ROUTE + "Company/getSCompanybyid",                      //获取二级部门
        }

    }

    //下拉选择------------------------------------------------------------------------
    $.ajax({
        url     : personnel_company_api.select,
        type    : "POST",
        dataType: "json",
        success : function(data){
            //变量声明
            var data = data.data;
            var personnel_company_first_id = data[0].id;                    //初始ID

            //下拉选择-选项填充
            var resu = "";
            for(i=0;i<data.length;i++){
                resu += `<option value="${data[i].id}">${data[i].name}</option>`;
            }
            personnel_company_tool_select1.html(resu);

            //架构组件-ID影响
            personnel_company_structure_btn.attr("company-id",personnel_company_first_id);

            //数据表格
            personnel_company_datagrid.datagrid({
                height      : um_height(personnel_company_datagrid),
                sortable    : false,
                cache       : false,
                showRowIndex: true,
                configs     : {
                    R0:{className:"text-center"},
                    C1:{className:"cell-hidden"}
                },
                states      : {
                    pager           : {
                        page        : 1,
                        recPerPage  : window.REC_PER_PAGE,
                    }
                },
                dataSource : {
                    cols   : [
                        {name:"deparmenid"  ,label:"ID" ,width:9},
                        {name:"deparmenname",label:"部门",width:80},
                        {name:"staffname"   ,label:"人员",width:80},
                        {name:"positionname",label:"职务",width:80},
                        {name:"tel"         ,label:"电话",width:100}
                    ],
                    remote : function(){
                        return {
                            url     : personnel_company_api.datagrid,
                            type    : "POST",
                            dataType: "json",
                            data    : { id : personnel_company_first_id }
                        }
                    }
                }
            });
            //变量声明
            personnel_company_datagrid_obj = personnel_company_datagrid.data("zui.datagrid");       //表格对象
        }
    }); 

    //下拉选择-改动-------------------------------------------------------------------
    personnel_company_tool_select1.change(function(){

        //变量声明
        var data_id = personnel_company_tool_select1.val();                                         //数据ID

        //改动影响
        personnel_company_structure_btn.attr("company-id",data_id);                                 //架构传值
        um_render(personnel_company_datagrid_obj,personnel_company_api.datagrid + "?id="+data_id);  //表格渲染
        
    });

    //架构组件------------------------------------------------------------------------
    personnel_company_structure_btn.click(function(){
        $.ajax({
            url     : personnel_company_api.structure,
            type    : "POST",
            dataType: "json",
            data    : { id  : personnel_company_structure_btn.attr("company-id") },
            success : function(data){
                var data = data.data;
                var data = um_json(data);                                                           //JSON解析
                personnel_company_structure_dom.treemap("render",data);                             //架构渲染
                personnel_company_structure_box.modal("show");                                      //面板显示
            }
        });
    });

});//预加载结尾
</script>